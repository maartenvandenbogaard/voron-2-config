[delayed_gcode gradual_cooldown]
gcode:
    {% if printer.heater_bed.target > 40 %}
        M118 reduce temp to ({printer.heater_bed.target - 5 }C).
        M140 S{ printer.heater_bed.target - 5 }
        UPDATE_DELAYED_GCODE ID=gradual_cooldown DURATION=300
    {% else %}
        M118 Gradual bed cooling finished ({printer.heater_bed.temperature}C).
        M140 S0 ; turn off bed
        M118 Print Complete!
    {% endif %}

[gcode_macro PRINT_END]
description: Stop the print and filter the atmosphere for 10min before shuting down
gcode:
    {% set disable_motors_in_end_print = printer["gcode_macro _USER_VARIABLES"].disable_motors_in_end_print %}

    M400

    PARK
    _TIP_SHAPING
    G1 E-10 F2100

    M104 S0 ; Turn off Extruder
    M106 S0 ; Turn off Fan
    
    BEDFANSOFF
    M107
    BED_MESH_CLEAR
    {% if disable_motors_in_end_print %}
        M84
    {% endif %}	


    # If a filter is connected, filter the air at full power
    # for a couple of min before stopping everything
    {% set FILTER_TIME = params.FILTER_TIME|default(10)|int %}
    START_FILTER SPEED=1
    UPDATE_DELAYED_GCODE ID=_STOP_FILTER_DELAYED DURATION={FILTER_TIME}

    LIGHT_ON S=30
    STATUS_OFF

    {% if printer.heater_bed.temperature > 60 %}
        M118 Start gradual bed cooling ({printer.heater_bed.temperature}C).
        M118 reduce temp to ({printer.heater_bed.temperature - 5 }C).
        M140 S{ printer.heater_bed.target - 5 }
        UPDATE_DELAYED_GCODE ID=gradual_cooldown DURATION=300
    {% else %}
        M118 No Gradual bed cooling necessary ({printer.heater_bed.temperature}C).
        M140 S0 ; turn off bed
        M81 ; disable Power
        M118 Print Complete!
    {% endif %}
